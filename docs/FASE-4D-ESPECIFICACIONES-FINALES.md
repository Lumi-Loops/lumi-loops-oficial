# Fase 4D - Especificaciones Finales: Componentes UI, APIs REST y Testing\n\n**Estado:** Listo para ImplementaciÃ³n \n**Prioridad:** ÃšLTIMA FASE antes de APIs Fase 5 \n\n---\n\n## ðŸŽ¨ Componentes UI Pendientes (4 componentes)\n\nTodos deben usar **shadcn/ui** y seguir las convenciones del proyecto.\n\n### 1. AdminTicketsInbox\n**UbicaciÃ³n:** `src/components/admin/AdminTicketsInbox.tsx`\n\n**CaracterÃ­sticas:**\n- Tabla filtrable con columnas: ID, Visitante, Estado, Prioridad, Creado, Acciones\n- Filtros por estado, prioridad, bÃºsqueda de nombre/email\n- BotÃ³n \"Asignarme\" para tickets sin asignar\n- BotÃ³n \"Ver Detalles\" para tickets asignados\n- Refresh automÃ¡tico cada 30 segundos\n- Badges de color por estado/prioridad\n- PaginaciÃ³n para listas grandes\n\n**Propiedades de Ticket:**\n`typescript\ninterface SupportTicket {\n  id: string;\n  inquiry_id: string;\n  status: 'new' | 'in_progress' | 'resolved' | 'closed';\n  priority: 'low' | 'normal' | 'high' | 'urgent';\n  assigned_to?: string;\n  visitor_name: string;\n  visitor_email: string;\n  message: string;\n  created_at: string;\n  updated_at: string;\n}\n`\n\n---\n\n### 2. AdminResponseForm\n**UbicaciÃ³n:** `src/components/admin/AdminResponseForm.tsx`\n\n**CaracterÃ­sticas:**\n- Campo de texto enriquecido para respuesta (min 10 caracteres)\n- Campo URL opcional para enlace descarga\n- Toggle \"Enviar Email\"\n- ValidaciÃ³n con Zod\n- Alertas de Ã©xito/error\n- Crear entrada en `admin_responses`\n- Crear entrada en `admin_notifications_queue` si email=true\n- Actualizar `support_tickets.updated_at`\n\n**Workflow:**\n1. Validar form\n2. Insertar en `admin_responses`\n3. Si send_email, obtener linked_user_id de inquiry\n4. Crear en `admin_notifications_queue`\n5. Trigger notificaciÃ³n al usuario\n6. Registrar en `admin_audit_log`\n\n---\n\n### 3. UserActivityView\n**UbicaciÃ³n:** `src/components/admin/UserActivityView.tsx`\n\n**CaracterÃ­sticas:**\n- Cards con mÃ©tricas: citas, pagos, descargas\n- Timeline de actividad reciente\n- Indicadores de estado con colores\n- Last login, total acumulados\n- Modal expandible con detalles\n- Query O(1) desde `user_activity_cache`\n\n**Props:**\n`typescript\ninterface UserActivityViewProps {\n  userId: string;\n}\n`\n\n---\n\n### 4. AdminAuditLog\n**UbicaciÃ³n:** `src/components/admin/AdminAuditLog.tsx`\n\n**CaracterÃ­sticas:**\n- Tabla paginada con filtros\n- Columnas: Fecha, Admin, AcciÃ³n, Target, Cambios\n- Filtros: rango fechas, admin, tipo acciÃ³n, tipo target\n- Export a CSV\n- Detalle expandible de cambios JSON\n- Solo accesible a super_admin\n\n---\n\n## ðŸ”Œ APIs REST Requeridas\n\n### 1. Admin Tickets API\n**Archivo:** `src/app/api/admin/tickets/route.ts`\n\n`typescript\n// GET /api/admin/tickets\n// Query params: status?, priority?, search?\n// Response: SupportTicket[]\n\n// PATCH /api/admin/tickets/:id\n// Body: { status?, priority?, assigned_to? }\n// Response: SupportTicket\n`\n\n### 2. Admin Responses API\n**Archivo:** `src/app/api/admin/responses/route.ts`\n\n`typescript\n// POST /api/admin/responses\n// Body: { support_ticket_id, response_text, download_link?, send_email }\n// Response: AdminResponse\n\n// GET /api/admin/responses?ticket_id=\n// Response: AdminResponse[]\n`\n\n### 3. Notifications Queue API\n**Archivo:** `src/app/api/admin/notifications/route.ts`\n\n`typescript\n// GET /api/admin/notifications\n// Query params: status?, limit?\n// Response: QueuedNotification[]\n\n// PATCH /api/admin/notifications/:id/retry\n// Response: { success: bool }\n\n// PATCH /api/admin/notifications/:id/skip\n// Response: { success: bool }\n\n// GET /api/admin/notifications/stats\n// Response: { total_queued, total_failed, success_rate }\n`\n\n### 4. Admin Audit Log API\n**Archivo:** `src/app/api/admin/audit-log/route.ts`\n\n`typescript\n// GET /api/admin/audit-log\n// Query params: admin_id?, action?, start_date?, end_date?, limit?\n// Response: AuditLog[]\n\n// GET /api/admin/audit-log/export\n// Response: CSV file\n`\n\n### 5. Users Activity API\n**Archivo:** `src/app/api/admin/users/route.ts`\n\n`typescript\n// GET /api/admin/users\n// Response: User[] (con activity_cache joinado)\n\n// GET /api/admin/users/:id/activity\n// Response: UserActivityCache\n`\n\n---\n\n## ðŸ§ª Testing Requerido\n\n### Test de Triggers (SQL)\n\n`sql\n-- Test 1: Crear respuesta actualiza ticket timestamp\nINSERT INTO admin_responses (...)\nVALUES (...);\n\nSELECT updated_at FROM support_tickets \nWHERE id = (SELECT support_ticket_id FROM admin_responses LIMIT 1);\n-- Debe mostrar NOW()\n\n-- Test 2: ReasignaciÃ³n registra audit\nSELECT reassign_ticket('ticket-uuid', 'new-admin-uuid');\n\nSELECT * FROM admin_audit_log \nWHERE action = 'ticket_reassigned'\nORDER BY created_at DESC LIMIT 1;\n-- Debe mostrar cambio registrado\n\n-- Test 3: Cache se actualiza con nueva cita\nINSERT INTO appointments (user_id, scheduled_date, status)\nVALUES ('user-uuid', NOW() + INTERVAL '1 day', 'scheduled');\n\nSELECT total_appointments, last_appointment_date \nFROM user_activity_cache \nWHERE user_id = 'user-uuid';\n-- total_appointments debe incrementar\n`\n\n### Test de RLS\n\n`typescript\n// Test como support_agent\nconst { data: tickets } = await supabase\n  .from('support_tickets')\n  .select()\n  .eq('assigned_to', agentId);\n// Debe retornar solo tickets asignados a este agente\n\n// Test como super_admin\nconst { data: allLogs } = await supabase\n  .from('admin_audit_log')\n  .select();\n// Debe retornar todos los logs\n\n// Test como usuario normal\nconst { data: userTickets } = await supabase\n  .from('support_tickets')\n  .select();\n// Debe retornar error o lista vacÃ­a (usuario no admin)\n`\n\n### Test de APIs\n\n`typescript\n// Test assign ticket\nconst response = await fetch('/api/admin/tickets/ticket-id', {\n  method: 'PATCH',\n  body: JSON.stringify({ \n    assigned_to: 'admin-uuid',\n    status: 'in_progress'\n  })\n});\n// Debe retornar 200 con ticket actualizado\n\n// Test enviar respuesta\nconst response = await fetch('/api/admin/responses', {\n  method: 'POST',\n  body: JSON.stringify({\n    support_ticket_id: 'ticket-id',\n    response_text: 'Esta es mi respuesta',\n    download_link: 'https://example.com/file.pdf',\n    send_email: true\n  })\n});\n// Debe retornar 201 con respuesta creada\n// Debe crear en notifications_queue\n`\n\n---\n\n## ðŸ“‹ Checklist de ImplementaciÃ³n Fase 4D\n\n### Componentes React\n- [ ] AdminTicketsInbox con tabla filtrable\n- [ ] AdminResponseForm con validaciÃ³n Zod\n- [ ] UserActivityView con mÃ©tricas\n- [ ] AdminAuditLog con filtros y export\n- [ ] NotificationQueueAdmin con retry\n\n### APIs REST\n- [ ] GET /api/admin/tickets (con filtros)\n- [ ] PATCH /api/admin/tickets/:id\n- [ ] POST /api/admin/responses\n- [ ] GET /api/admin/responses\n- [ ] GET /api/admin/notifications\n- [ ] PATCH /api/admin/notifications/:id/retry\n- [ ] GET /api/admin/notifications/stats\n- [ ] GET /api/admin/audit-log\n- [ ] GET /api/admin/audit-log/export (CSV)\n- [ ] GET /api/admin/users\n\n### Testing\n- [ ] Tests SQL de triggers\n- [ ] Tests RLS policies\n- [ ] Tests de APIs\n- [ ] Tests de workflow completo\n- [ ] Tests de error handling\n\n### DocumentaciÃ³n\n- [ ] Diagrama ER Mermaid\n- [ ] JSON Schema de tablas\n- [ ] Instrucciones de testing\n- [ ] Tabla de permisos por rol\n\n---\n\n## âœ… PrÃ³ximos Pasos\n\n1. Implementar 5 componentes React con shadcn/ui\n2. Crear 10 endpoints API REST\n3. Ejecutar tests completos\n4. Crear documentaciÃ³n final\n5. **Commit:** \"feat: Implementar Fase 4D completa - UI, APIs y testing\"\n6. **Proceder:** Fase 5 - APIs de Cliente (Appointments, Payments, Downloads)\n\n---\n\n## ðŸ“Š Estado General del Proyecto\n\n### Completado âœ…\n- Fase 1-3: Base de datos (7 tablas, 21 Ã­ndices, 8 triggers)\n- Fase 4A-C: Admin system DB (6 tablas, permisos, auditorÃ­a, cache, queue)\n\n### En Progreso ðŸ”„\n- Fase 4D: UI/APIs/Testing admin\n\n### PrÃ³ximo ðŸš€\n- Fase 5: APIs de cliente (Appointments, Payments, Downloads, Notifications)\n- Fase 6: DocumentaciÃ³n final + deployment\n\n---\n\n## ðŸ’¾ Archivos a Crear/Modificar\n\n`\nsrc/\nâ”œâ”€â”€ components/admin/\nâ”‚   â”œâ”€â”€ AdminTicketsInbox.tsx          (CREAR)\nâ”‚   â”œâ”€â”€ AdminResponseForm.tsx          (CREAR)\nâ”‚   â”œâ”€â”€ UserActivityView.tsx           (CREAR)\nâ”‚   â”œâ”€â”€ AdminAuditLog.tsx              (CREAR)\nâ”‚   â””â”€â”€ NotificationQueueAdmin.tsx     (CREAR)\nâ”œâ”€â”€ app/api/admin/\nâ”‚   â”œâ”€â”€ tickets/route.ts               (CREAR)\nâ”‚   â”œâ”€â”€ responses/route.ts             (CREAR)\nâ”‚   â”œâ”€â”€ notifications/route.ts         (CREAR)\nâ”‚   â”œâ”€â”€ audit-log/route.ts             (CREAR)\nâ”‚   â””â”€â”€ users/route.ts                 (CREAR)\nâ”œâ”€â”€ app/admin/\nâ”‚   â”œâ”€â”€ page.tsx                       (CREAR - Dashboard)\nâ”‚   â”œâ”€â”€ tickets/\nâ”‚   â”‚   â”œâ”€â”€ page.tsx                   (CREAR)\nâ”‚   â”‚   â””â”€â”€ [id]/page.tsx              (CREAR)\nâ”‚   â”œâ”€â”€ notifications/page.tsx         (CREAR)\nâ”‚   â”œâ”€â”€ audit/page.tsx                 (CREAR)\nâ”‚   â””â”€â”€ users/page.tsx                 (CREAR)\nâ””â”€â”€ types/\n    â””â”€â”€ admin.ts                       (CREAR - TypeScript interfaces)\n`\n\n---\n\n## ðŸŽ¯ ConclusiÃ³n\n\nFase 4D cierra el sistema administrativo completo. Una vez completada:\n- âœ… Admin puede gestionar todos los tickets\n- âœ… AuditorÃ­a completa de acciones\n- âœ… Notificaciones con retry automÃ¡tico\n- âœ… Permisos granulares por rol\n- âœ… Performance optimizado con cache\n\n**Estimado:** 6-8 horas de desarrollo para los 5 componentes + 10 APIs + testing.\n"}
